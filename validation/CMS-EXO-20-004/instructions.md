## Recasting Validation

In order to produce the validation results for CMS-EXO-20-004, firstly make sure that [external packages and additional dependencies](../../README.md) are installed. Secondly, the following steps should be taken:

 1. *Generation of MC events*: events for a set of model points can be generated using the MadGraph->Pythia8->Delphes pipeline using the script [runScanMG5.py](./runScanMG5.py):
 ```
 ./runScanMG5.py -p <parameters-file>
 ```
 where the scan parameters are defined by a steering card, such as [scan_parameters_0j_spin1.ini](./scan_parameters_0j_spin1.ini). The scan can be run in series or parallel. However, since MG5 already parallelize much of the event generation, it is recommended to run it in series. The Delphes output will be stored in the process folder with all the runs.

  2. *Recasting and event selection*: the recasting of CMS-EXO-20-004 is implemented by the [cms_exo_20_004-Recast.py](./cms_exo_20_004-Recast.py) code and can be run as:
   ```
   ./cms_exo_20_004-Recast.py -f <list of Delphes input files>
  ```
  where the list of input files could correspond to (matched) event samples with 0 and 1 jets, for instance. Note that the weights of the input files will be directly added without any additional normalization applied. The results with the cutflow and SR events will be stored in a pickle file containing a Pandas DataFrame.

  3. *Combination of results*: for convenience results from individual models (or model points) can be combined in a single pickle file. This can be done running:
   ```
   ./cms_exo_20_004-CombinedData.py -f <list of pickle files> -o <output file>
  ```
  where the input should be a list of pickle files generated by the previous step for each model point. The combined data will be stored in a single pickle file containing a DataFrame with all the points.

  4. *Computation of upper limits*: finally, upper limits on the signal strength can be computed for a single (or combined) DataFrame running:
   ```
   ./cms_exo_20_004-UpperLimits.py -f <input pickle>
  ```  
  and takes as input a pickle file containing the data for one or multiple model points. The upper limits are computed using the simplified likelihood approach and makes use of the monojet covariance matrix provided by CMS.

  5. *Plotting the results*: the results can be plotted using the jupyter notebooks stored in [notebooks](./notebooks). In particular:

  * [plotValidation-xx.ipynb](./notebooks/plotValidation-Axial.ipynb): plots the upper limits on the signal strength as a function of the model parameters.
  * [cms_exo_20_004-Compxx.ipynb](./notebooks/cms_exo_20_004-CompSpin1.ipynb): compares the cutflow and signal yields in each SR bin to the CMS results.
  * [plotDJR.ipynb](./notebooks/plotDJR.ipynb): plots the differential jet rate generated by MadGraph5 for checking the matching procedure.

### Example

As an example, to generate the validation plots for the axial (spin 1) model the following steps should be taken:

  1.   ```./runScanMG5.py -p scan_parameters_0j_spin1.ini``` 
       ```./runScanMG5.py -p scan_parameters_1j_spin1.ini``` 
       
       (generates the 0 and 1 jet matched samples)
  
  2. ```for i in DMSimp_axial_0j_match/Events/run*/*root; do ./cms_exo_20_004-Recast.py -f $i ${i/0j/1j}; done```
  
     (generates the recasting data for each model point combining the 0j and 1j samples)

  3. ```./cms_exo_20_004-CombinedData.py -f DMSimp_axial_0j_match/Events/run*/*pcl -o scanResults_axial.pcl```

     (combines all the scan results into a single dataFrame)

  4. ```./cms_exo_20_004-UpperLimits.py -f scanResults_axial.pcl```

     (compute the upper limits for each model point)
  
  5. Plot the results using [./notebooks/plotValidation-Axial.ipynb](./notebooks/plotValidation-Axial.ipynb)