# MonoXSMS
Repository for storing the code and results for studies related to LHC Mono-X searches and simplified models (SMS)


## Repo Description

 * [AuxInfo](./AuxInfo): Stores official auxiliary data from ATLAS and CMS
 * [Cards](./Cards): Cards for generating events with MadGraph5
 * [modelFiles](./modelFiles): UFO files for the Simplified DM models
 * [notebooks](./notebooks): Jupyter notebooks for recasting and plotting
 * [Refs](./Refs): Useful links to references

## External Packages


Currently the following tools can be installed and might be needed for running the 
recasting codes:

  * [MadGraph5](https://launchpad.net/mg5amcnlo/)[^1]
  * [Delphes](https://cp3.irmp.ucl.ac.be/projects/delphes)
  * [Pythia8](https://pythia.org/)
  * [HepMC](http://hepmc.web.cern.ch/hepmc/)
  * [MadAnalysis5](https://github.com/MadAnalysis/madanalysis5)[^2]  


Executing:

```
./installer.sh
```

Will try to fetch the required packages and install them in the current folder.


### Additional Dependencies

The following packages/tools must already be installed in the system:

 * autoconf
 * libtool
 * gzip
 * bzr
 * [ROOT](https://root.cern/)
 
In addition the variable $ROOTSYS must be properly defined.
 
For installing ROOT the following steps can be taken:

 1. Download the tarball from [ROOT releases](https://root.cern/install/all_releases/)
 2. Install all the required dependencies (see [ROOT dependencies](https://root.cern/install/dependencies/))
 3. Extract the tarball to root-src
 4. Make the build and installation dirs (mkdir root-build root-<version>)
 5. In the buld folder run:

```
cmake ../root-src -DCMAKE_INSTALL_PREFIX=$homeDIR/root-<version> -Dall=ON -Dmemstat=OFF
make
make install
```


## Recasting Validation

In order to produce the validation results for CMS-EXO-20-004 the following steps should be taken:

 1. *Generation of MC events*: events for a set of model points can be generated using the MadGraph->Pythia8->Delphes pipeline using the script [runScanMG5.py](./runScanMG5.py):
 ```
 ./runScanMG5.py -p <parameters-file>
 ```
 where the scan parameters are defined by a steering card, such as [scan_parameters_0j_spin1.ini](./scan_parameters_0j_spin1.ini). The scan can be run in series or parallel. However, since MG5 already parallelize much of the event generation, it is recommended to run it in series. The Delphes output will be stored in the process folder with all the runs.

  2. *Recasting and event selection*: the recasting of CMS-EXO-20-004 is implemented by the [cms_exo_20_004-Recast.py](./cms_exo_20_004-Recast.py) code and can be run as:
   ```
   ./cms_exo_20_004-Recast.py -f <list of Delphes input files>
  ```
  where the list of input files could correspond to (matched) event samples with 0 and 1 jets, for instance. Note that the weights of the input files will be directly added without any additional normalization applied. The results with the cutflow and SR events will be stored in a pickle file containing a Pandas DataFrame.

  3. *Combination of results*: for convenience results from individual models (or model points) can be combined in a single pickle file. This can be done running:
   ```
   ./cms_exo_20_004-CombinedData.py -f <list of pickle files> -o <output file>
  ```
  where the input should be a list of pickle files generated by the previous step for each model point. The combined data will be stored in a single pickle file containing a DataFrame with all the points.

  4. *Computation of upper limits*: finally, upper limits on the signal strength can be computed for a single (or combined) DataFrame running:
   ```
   ./cms_exo_20_004-UpperLimits.py -f <input pickle>
  ```  
  and takes as input a pickle file containing the data for one or multiple model points. The upper limits are computed using the simplified likelihood approach and makes use of the monojet covariance matrix provided by CMS.

  5. *Plotting the results*: the results can be plotted using the jupyter notebooks stored in [notebooks](./notebooks). In particular:

  * [plotValidation-xx.ipynb](./notebooks/plotValidation-Axial.ipynb): plots the upper limits on the signal strength as a function of the model parameters.
  * [cms_exo_20_004-Compxx.ipynb](./notebooks/cms_exo_20_004-CompSpin1.ipynb): compares the cutflow and signal yields in each SR bin to the CMS results.
  * [plotDJR.ipynb](./notebooks/plotDJR.ipynb): plots the differential jet rate generated by MadGraph5 for checking the matching procedure.

### Example

As an example, to generate the validation plots for the axial (spin 1) model the following steps should be taken:

  1.   ```./runScanMG5.py -p scan_parameters_0j_spin1.ini``` 
       ```./runScanMG5.py -p scan_parameters_1j_spin1.ini``` 
       
       (generates the 0 and 1 jet matched samples)
  
  2. ```for i in DMSimp_axial_0j_match/Events/run*/*root; do ./cms_exo_20_004-Recast.py -f $i ${i/0j/1j}; done```
  
     (generates the recasting data for each model point combining the 0j and 1j samples)

  3. ```./cms_exo_20_004-CombinedData.py -f DMSimp_axial_0j_match/Events/run*/*pcl -o scanResults_axial.pcl```

     (combines all the scan results into a single dataFrame)

  4. ```./cms_exo_20_004-UpperLimits.py -f scanResults_axial.pcl```

     (compute the upper limits for each model point)
  
  5. Plot the results using [./notebooks/plotValidation-Axial.ipynb](./notebooks/plotValidation-Axial.ipynb)


### Validation Results

  Note that the limits provide by CMS include a combination of the Mono-V and MonoJet signal regions, while the results computed here only include the MonoJet SRs. Furthermore for the spin-1 (axial and vector) models, CMS computes the events at NLO, so a small k-factor has to be applied. The k-factor depends on the model point, but we apply a flat value for all points.


[^1]: In recent python versions the installation of LHAPDF6 through MadGraph might fail, because it uses an old LHAPDF version. In order to install it,
     one needs to modify the lhapdf6 version to its [latest version](https://lhapdf.hepforge.org/downloads/) in MG5/HEPTools/HEPToolsInstallers/HEPToolInstaller.py
     and run (within the MG5 folder):
     ```
     ./HEPTools/HEPToolsInstallers/HEPToolInstaller.py lhapdf6
     ```     
     
[^2]: The Delphes card for the MadAnalysis5 implementation of CMS-EXO-20-004 must be replaced by [Cards/delphes_card.dat](./Cards/delphes_card.dat)
      in order to probably treat the DM particles with PDGs 51 and 52.

